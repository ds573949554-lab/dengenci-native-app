<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é‚“æ©èµ - æœåŠ¡å™¨é…ç½®</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .container {
      background: white;
      border-radius: 20px;
      padding: 30px;
      max-width: 400px;
      width: 100%;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    }

    h1 {
      font-size: 24px;
      text-align: center;
      margin-bottom: 10px;
      color: #333;
    }

    .subtitle {
      text-align: center;
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
    }

    .status {
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      text-align: center;
      font-size: 14px;
    }

    .status.disconnected {
      background: #fee;
      color: #c33;
    }

    .status.connected {
      background: #efe;
      color: #3c3;
    }

    .status.checking {
      background: #ffc;
      color: #963;
    }

    .input-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
      color: #555;
      font-weight: 500;
    }

    input[type="text"] {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 14px;
      transition: border-color 0.3s;
    }

    input[type="text"]:focus {
      outline: none;
      border-color: #667eea;
    }

    .button-group {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    button {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    button:active {
      transform: scale(0.98);
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-secondary {
      background: #f0f0f0;
      color: #333;
    }

    .info-box {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 10px;
      font-size: 12px;
      color: #666;
      line-height: 1.6;
    }

    .info-box h3 {
      font-size: 14px;
      margin-bottom: 8px;
      color: #333;
    }

    .info-box code {
      background: #e0e0e0;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: monospace;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ§š é‚“æ©èµ</h1>
    <p class="subtitle">æœåŠ¡å™¨é…ç½®</p>

    <div id="status" class="status disconnected">
      âš ï¸ æœªè¿æ¥åˆ°æœåŠ¡å™¨
    </div>

    <div class="input-group">
      <label>æœåŠ¡å™¨åœ°å€</label>
      <input type="text" id="serverUrl" placeholder="ws://192.168.110.254:3001" value="ws://192.168.110.254:3001">
    </div>

    <div class="button-group">
      <button class="btn-primary" onclick="connect()">è¿æ¥</button>
      <button class="btn-secondary" onclick="autoDiscover()">è‡ªåŠ¨å‘ç°</button>
    </div>

    <div class="info-box">
      <h3>ğŸ’¡ ä½¿ç”¨è¯´æ˜</h3>

      <p><strong>åŒä¸€ WiFiï¼š</strong><br>
      ä½¿ç”¨å±€åŸŸç½‘åœ°å€ï¼ˆå¦‚ <code>ws://192.168.110.254:3001</code>ï¼‰</p>

      <p style="margin-top: 10px;"><strong>å¤–ç½‘è®¿é—®ï¼š</strong><br>
      1. ç”µè„‘å¯åŠ¨åŒæ­¥æœåŠ¡å™¨ï¼ˆä¼šæ˜¾ç¤º ngrok åœ°å€ï¼‰<br>
      2. å°† ngrok åœ°å€å¡«å…¥ä¸Šæ–¹<br>
      3. ç‚¹å‡»è¿æ¥</p>

      <p style="margin-top: 10px;"><strong>è‡ªåŠ¨å‘ç°ï¼š</strong><br>
      ç‚¹å‡»"è‡ªåŠ¨å‘ç°"æŒ‰é’®ï¼Œè‡ªåŠ¨æ‰«æå¯ç”¨æœåŠ¡å™¨</p>
    </div>
  </div>

  <script>
    let ws = null;
    let serverUrl = localStorage.getItem('dengenci_server_url') || 'ws://192.168.110.254:3001';
    document.getElementById('serverUrl').value = serverUrl;

    function updateStatus(type, message) {
      const statusEl = document.getElementById('status');
      statusEl.className = 'status ' + type;
      statusEl.textContent = message;
    }

    function connect() {
      const url = document.getElementById('serverUrl').value;

      if (!url) {
        alert('è¯·è¾“å…¥æœåŠ¡å™¨åœ°å€');
        return;
      }

      updateStatus('checking', 'ğŸ”„ æ­£åœ¨è¿æ¥...');

      if (ws) {
        ws.close();
      }

      ws = new WebSocket(url + '?type=mobile');

      ws.onopen = () => {
        updateStatus('connected', 'âœ… å·²è¿æ¥åˆ°æœåŠ¡å™¨');
        localStorage.setItem('dengenci_server_url', url);

        setTimeout(() => {
          window.location.href = 'index.html';
        }, 1000);
      };

      ws.onerror = () => {
        updateStatus('disconnected', 'âŒ è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥åœ°å€');
      };

      ws.onclose = () => {
        updateStatus('disconnected', 'âŒ è¿æ¥å·²æ–­å¼€');
      };
    }

    async function autoDiscover() {
      updateStatus('checking', 'ğŸ” æ­£åœ¨æœç´¢æœåŠ¡å™¨...');

      const commonUrls = [
        'ws://192.168.110.254:3001',
        'ws://192.168.1.1:3001',
        'ws://192.168.0.1:3001',
        'ws://10.0.0.1:3001'
      ];

      // å°è¯•ä»æœ¬åœ°å­˜å‚¨çš„ ngrok URL
      const savedNgrokUrl = localStorage.getItem('dengenci_ngrok_url');
      if (savedNgrokUrl) {
        commonUrls.unshift(savedNgrokUrl);
      }

      for (const url of commonUrls) {
        try {
          const response = await fetch(url.replace('ws://', 'http://').replace(':3001', ':3001/health'), {
            method: 'GET',
            timeout: 2000
          });

          if (response.ok) {
            const data = await response.json();

            if (data.status === 'ok') {
              document.getElementById('serverUrl').value = url;

              if (url.includes('ngrok')) {
                localStorage.setItem('dengenci_ngrok_url', url);
              }

              updateStatus('connected', `âœ… æ‰¾åˆ°æœåŠ¡å™¨ï¼${data.desktopConnected ? 'ç”µè„‘åœ¨çº¿' : 'ç”µè„‘ç¦»çº¿'}`);
              return;
            }
          }
        } catch (error) {
          // ç»§ç»­å°è¯•ä¸‹ä¸€ä¸ª
        }
      }

      updateStatus('disconnected', 'âŒ æœªæ‰¾åˆ°å¯ç”¨æœåŠ¡å™¨ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥åœ°å€');
    }

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨å°è¯•è¿æ¥
    window.addEventListener('load', () => {
      if (localStorage.getItem('dengenci_connected') === 'true') {
        window.location.href = 'index.html';
      }
    });
  </script>
</body>
</html>
