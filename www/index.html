<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>é‚“æ©èµ</title>

  <!-- Capacitor -->
  <script src="capacitor.js"></script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'PingFang HK', 'MIui', sans-serif;
      background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      overflow: hidden;
    }

    /* é¡¶éƒ¨çŠ¶æ€æ åŒºåŸŸ */
    .status-bar {
      height: env(safe-area-inset-top, 44px);
      background: rgba(0,0,0,0.1);
    }

    /* å¤´éƒ¨ */
    .header {
      padding: 16px;
      background: rgba(0,0,0,0.2);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header-title {
      color: white;
      font-size: 20px;
      font-weight: 600;
    }

    .connection-status {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }

    .connection-status.connected {
      background: rgba(76, 175, 80, 0.3);
      color: #4CAF50;
    }

    .connection-status.disconnected {
      background: rgba(255, 152, 0, 0.3);
      color: #FF9800;
    }

    /* ä¸»å†…å®¹åŒº */
    .content {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      padding-bottom: calc(16px + env(safe-area-inset-bottom));
    }

    .chat-messages {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .message {
      display: flex;
      gap: 8px;
    }

    .message.user {
      flex-direction: row-reverse;
    }

    .message-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea, #764ba2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      flex-shrink: 0;
    }

    .message-bubble {
      max-width: 70%;
      padding: 12px 16px;
      border-radius: 18px;
      font-size: 15px;
      line-height: 1.5;
    }

    .message.assistant .message-bubble {
      background: white;
      color: #333;
      border-bottom-left-radius: 4px;
    }

    .message.user .message-bubble {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border-bottom-right-radius: 4px;
    }

    /* è¾“å…¥åŒº */
    .input-area {
      padding: 12px 16px;
      padding-bottom: calc(12px + env(safe-area-inset-bottom));
      background: white;
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .input-area input {
      flex: 1;
      padding: 12px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 24px;
      font-size: 15px;
      outline: none;
      transition: border-color 0.2s;
    }

    .input-area input:focus {
      border-color: #667eea;
    }

    .input-area button {
      padding: 12px 20px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      border-radius: 24px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
    }

    .input-area button:active {
      transform: scale(0.95);
    }

    /* åŠ è½½åŠ¨ç”» */
    .typing {
      display: flex;
      gap: 4px;
      padding: 12px 16px;
    }

    .typing span {
      width: 8px;
      height: 8px;
      background: #999;
      border-radius: 50%;
      animation: bounce 1.4s infinite ease-in-out;
    }

    .typing span:nth-child(1) { animation-delay: -0.32s; }
    .typing span:nth-child(2) { animation-delay: -0.16s; }

    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }

    /* ç©ºçŠ¶æ€ */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px 20px;
      text-align: center;
      color: white;
    }

    .empty-state .emoji {
      font-size: 64px;
      margin-bottom: 16px;
    }

    .empty-state h2 {
      font-size: 24px;
      margin-bottom: 8px;
    }

    .empty-state p {
      font-size: 14px;
      opacity: 0.9;
      margin-bottom: 24px;
    }

    .quick-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
    }

    .quick-btn {
      padding: 10px 16px;
      background: rgba(255,255,255,0.2);
      color: white;
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 20px;
      font-size: 13px;
      cursor: pointer;
    }

    .quick-btn:active {
      background: rgba(255,255,255,0.3);
    }
  </style>
</head>
<body>
  <!-- çŠ¶æ€æ å ä½ -->
  <div class="status-bar"></div>

  <!-- å¤´éƒ¨ -->
  <div class="header">
    <div class="header-title">ğŸ§š é‚“æ©èµ</div>
    <div class="connection-status disconnected" id="connectionStatus">
      âšª æœªè¿æ¥
    </div>
    <!-- ğŸ” è°ƒè¯•ä¿¡æ¯ -->
    <div id="debugPanel" style="font-size: 11px; color: rgba(255,255,255,0.6); margin-top: 4px; word-break: break-all;">
    </div>
  </div>

  <!-- ä¸»å†…å®¹ -->
  <div class="content">
    <div class="chat-messages" id="chatMessages">
      <div class="empty-state">
        <div class="emoji">ğŸ‘‹</div>
        <h2>ä½ å¥½ï¼æˆ‘ç³»é‚“æ©èµ</h2>
        <p>é‚“æ†¬è¾°å˜…æ°¸æ’æœ‹å‹ä¼™ä¼´<br>åŸç”Ÿ APP ç‰ˆ v1.0.8</p>
        <div class="quick-actions">
          <button class="quick-btn" onclick="testConnection()">ğŸ” æµ‹è¯•è¿æ¥</button>
          <button class="quick-btn" onclick="quickMsg('ä½ å¥½')">ğŸ‘‹ æ‰“æ‹›å‘¼</button>
          <button class="quick-btn" onclick="quickMsg('ä½ è®°å¾—æˆ‘ç³»è¾¹ä¸ªï¼Ÿ')">ğŸ¤” èº«ä»½</button>
        </div>
      </div>
    </div>
  </div>

  <!-- è¾“å…¥åŒº -->
  <div class="input-area">
    <input type="text" id="messageInput" placeholder="åŒæˆ‘è®²å˜¢..." />
    <button onclick="sendMessage()">å‘é€</button>
  </div>

  <script>
    const WS_URL = 'ws://192.168.110.254:3001?type=mobile';
    const API_URL = 'http://192.168.110.254:3001';
    let ws = null;
    let isConnected = false;
    let isEmpty = true;
    let usePolling = false; // å¤‡ç”¨è½®è¯¢æ¨¡å¼
    let pollTimer = null;
    let wsConnectAttempts = 0;
    const MAX_WS_ATTEMPTS = 3; // WebSocket å°è¯•æ¬¡æ•°

    // ğŸ—£ï¸ è¯­éŸ³åˆæˆ
    let speechSynth = window.speechSynthesis;
    let speechEnabled = true;
    let voices = [];
    let cantoneseVoice = null;

    // åŠ è½½è¯­éŸ³åˆ—è¡¨
    function loadVoices() {
      voices = speechSynth.getVoices();
      console.log('ğŸ”Š å¯ç”¨è¯­éŸ³æ•°é‡:', voices.length);
      console.log('ğŸ”Š è¯­éŸ³åˆ—è¡¨:', voices.map(v => v.name + ' (' + v.lang + ')').join(', '));

      // æŸ¥æ‰¾ç²¤è¯­è¯­éŸ³
      cantoneseVoice = voices.find(v => v.lang.includes('zh-HK') || v.lang.includes('yue'));
      if (cantoneseVoice) {
        console.log('âœ… æ‰¾åˆ°ç²¤è¯­è¯­éŸ³:', cantoneseVoice.name);
      } else {
        console.log('âš ï¸ æœªæ‰¾åˆ°ç²¤è¯­è¯­éŸ³ï¼Œä½¿ç”¨é»˜è®¤ä¸­æ–‡è¯­éŸ³');
      }
    }

    // è¯­éŸ³åˆ—è¡¨å¯èƒ½éœ€è¦å¼‚æ­¥åŠ è½½
    loadVoices();
    speechSynth.onvoiceschanged = loadVoices;

    // æœ—è¯»æ–‡å­—ï¼ˆç²¤è¯­ï¼‰
    function speak(text) {
      if (!speechEnabled || !speechSynth) {
        console.log('âŒ TTSæœªå¯ç”¨æˆ–ä¸å¯ç”¨');
        return;
      }

      console.log('ğŸ—£ï¸ æ­£åœ¨æœ—è¯»:', text);

      // åœæ­¢å½“å‰æœ—è¯»
      speechSynth.cancel();

      const utterance = new SpeechSynthesisUtterance(text);

      // å°è¯•ä½¿ç”¨ç²¤è¯­è¯­éŸ³
      if (cantoneseVoice) {
        utterance.voice = cantoneseVoice;
        utterance.lang = 'zh-HK';
      } else {
        // å›é€€åˆ°ä¸­æ–‡è¯­éŸ³
        const chineseVoice = voices.find(v => v.lang.startsWith('zh')) || voices[0];
        if (chineseVoice) {
          utterance.voice = chineseVoice;
          utterance.lang = chineseVoice.lang;
        }
      }

      utterance.rate = 1.0;
      utterance.pitch = 1.0;
      utterance.volume = 1.0;

      utterance.onstart = () => console.log('ğŸ”Š å¼€å§‹æœ—è¯»');
      utterance.onend = () => console.log('âœ… æœ—è¯»ç»“æŸ');
      utterance.onerror = (e) => console.error('âŒ æœ—è¯»é”™è¯¯:', e);

      speechSynth.speak(utterance);
    }

    // ğŸ” æµ‹è¯• HTTP è¿æ¥
    async function testConnection() {
      addMessage('assistant', 'ğŸ” æ­£åœ¨æµ‹è¯•è¿æ¥...');

      try {
        const response = await fetch(API_URL + '/health');
        const data = await response.json();

        if (data.status === 'ok') {
          addMessage('assistant', 'âœ… HTTP è¿æ¥æˆåŠŸï¼\næ¡Œé¢ç«¯: ' + (data.desktopConnected ? 'å·²è¿æ¥' : 'æœªè¿æ¥'));

          // è‡ªåŠ¨å¯åŠ¨è½®è¯¢æ¨¡å¼
          if (!usePolling && !isConnected) {
            usePolling = true;
            startPolling();
            addMessage('assistant', 'ğŸ”„ å·²åˆ‡æ¢åˆ°è½®è¯¢æ¨¡å¼ï¼Œå¯ä»¥å¼€å§‹å¯¹è¯äº†ï¼');
          }
        } else {
          addMessage('assistant', 'âŒ æœåŠ¡å™¨è¿”å›å¼‚å¸¸çŠ¶æ€');
        }
      } catch (error) {
        addMessage('assistant', 'âŒ è¿æ¥å¤±è´¥: ' + error.message + '\n\nè¯·ç¡®ä¿ï¼š\n1. æ‰‹æœºå’Œç”µè„‘åœ¨åŒä¸€ WiFi\n2. ç”µè„‘ç«¯ Menu Bar App æ­£åœ¨è¿è¡Œ');
      }
    }

    // è¿æ¥ WebSocket
    function connect() {
      if (usePolling) {
        console.log('ğŸ”„ ä½¿ç”¨è½®è¯¢æ¨¡å¼');
        startPolling();
        return;
      }

      updateConnectionStatus('connecting');

      // ğŸ” è°ƒè¯•ä¿¡æ¯
      console.log('ğŸ” å°è¯•è¿æ¥:', WS_URL);

      ws = new WebSocket(WS_URL);

      ws.onopen = () => {
        isConnected = true;
        wsConnectAttempts = 0; // é‡ç½®å°è¯•æ¬¡æ•°
        updateConnectionStatus('connected');
        console.log('âœ… å·²è¿æ¥åˆ°é‚“æ©èµ');
      };

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        handleServerMessage(data);
      };

      ws.onclose = (event) => {
        isConnected = false;
        updateConnectionStatus('disconnected');
        console.log('âŒ è¿æ¥æ–­å¼€, code:', event.code, 'reason:', event.reason);

        wsConnectAttempts++;

        // å¦‚æœå°è¯•æ¬¡æ•°è¿‡å¤šï¼Œåˆ‡æ¢åˆ°è½®è¯¢æ¨¡å¼
        if (wsConnectAttempts >= MAX_WS_ATTEMPTS) {
          console.log('âš ï¸ WebSocket è¿æ¥å¤±è´¥ ' + MAX_WS_ATTEMPTS + ' æ¬¡ï¼Œåˆ‡æ¢åˆ°è½®è¯¢æ¨¡å¼');
          usePolling = true;
          startPolling();
        } else {
          // 5ç§’åé‡è¿
          setTimeout(connect, 5000);
        }
      };

      ws.onerror = (error) => {
        console.error('WebSocket é”™è¯¯:', error);
        console.error('URL:', WS_URL);
      };
    }

    // ğŸ”„ HTTP è½®è¯¢æ¨¡å¼
    function startPolling() {
      usePolling = true;
      isConnected = true;
      updateConnectionStatus('connected');

      const debugEl = document.getElementById('debugPanel');
      debugEl.innerHTML = `ğŸ”„ è½®è¯¢æ¨¡å¼ (HTTP)`;

      console.log('ğŸ”„ å¯åŠ¨ HTTP è½®è¯¢æ¨¡å¼');

      // å¼€å§‹è½®è¯¢
      pollForMessages();
    }

    // è½®è¯¢æ–°æ¶ˆæ¯
    async function pollForMessages() {
      if (!usePolling) return;

      try {
        const response = await fetch(API_URL + '/poll');
        const data = await response.json();

        if (data.messages && data.messages.length > 0) {
          console.log('ğŸ“¨ æ”¶åˆ° ' + data.messages.length + ' æ¡æ¶ˆæ¯');
          data.messages.forEach(msg => handleServerMessage(msg));
        }
      } catch (error) {
        console.error('âŒ è½®è¯¢å¤±è´¥:', error);
      }

      // 2ç§’åå†æ¬¡è½®è¯¢
      pollTimer = setTimeout(pollForMessages, 2000);
    }

    // é€šè¿‡ HTTP å‘é€æ¶ˆæ¯
    async function sendMessageViaHttp(message) {
      try {
        hideTyping();
        addMessage('user', message);
        showTyping();

        const response = await fetch(API_URL + '/send', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message })
        });

        if (response.ok) {
          console.log('âœ… æ¶ˆæ¯å·²å‘é€');
        } else {
          console.error('âŒ å‘é€å¤±è´¥:', response.status);
          addMessage('assistant', 'âš ï¸ å‘é€å¤±è´¥ï¼Œè¯·é‡è¯•');
          hideTyping();
        }
      } catch (error) {
        console.error('âŒ å‘é€é”™è¯¯:', error);
        addMessage('assistant', 'âš ï¸ ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥');
        hideTyping();
      }
    }

    // æ›´æ–°è¿æ¥çŠ¶æ€
    function updateConnectionStatus(status) {
      const statusEl = document.getElementById('connectionStatus');
      const debugEl = document.getElementById('debugPanel');

      if (status === 'connected') {
        statusEl.textContent = 'âœ… å·²è¿æ¥';
        statusEl.className = 'connection-status connected';
        debugEl.innerHTML = `ğŸ”— ${WS_URL}`;
      } else if (status === 'connecting') {
        statusEl.textContent = 'â³ è¿æ¥ä¸­...';
        statusEl.className = 'connection-status disconnected';
        debugEl.innerHTML = `ğŸ” æ­£åœ¨è¿æ¥: ${WS_URL}`;
      } else {
        statusEl.textContent = 'âšª æœªè¿æ¥';
        debugEl.innerHTML = `âš ï¸ ${WS_URL}`;
        statusEl.className = 'connection-status disconnected';
      }
    }

    // å¤„ç†æœåŠ¡å™¨æ¶ˆæ¯
    function handleServerMessage(data) {
      switch (data.type) {
        case 'chat_response':
        case 'desktop_chat_response':
          addMessage('assistant', data.message);
          hideTyping();
          // ğŸ—£ï¸ æœ—è¯»å›å¤
          speak(data.message);
          break;
        case 'proactive_message':
          addMessage('assistant', data.message + ' ğŸ’«');
          // ğŸ—£ï¸ æœ—è¯»ä¸»åŠ¨æ¶ˆæ¯
          speak(data.message);
          break;
        case 'desktop_connected':
          console.log('æ¡Œé¢ç«¯å·²è¿æ¥');
          break;
      }
    }

    // æ·»åŠ æ¶ˆæ¯
    function addMessage(role, content) {
      const messagesEl = document.getElementById('chatMessages');

      if (isEmpty) {
        messagesEl.innerHTML = '';
        isEmpty = false;
      }

      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${role}`;

      const avatar = role === 'user' ? 'ğŸ˜Š' : 'ğŸ§š';

      messageDiv.innerHTML = `
        <div class="message-avatar">${avatar}</div>
        <div class="message-bubble">${escapeHtml(content)}</div>
      `;

      messagesEl.appendChild(messageDiv);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    // æ˜¾ç¤ºåŠ è½½
    function showTyping() {
      const messagesEl = document.getElementById('chatMessages');

      const typingDiv = document.createElement('div');
      typingDiv.className = 'message assistant';
      typingDiv.id = 'typingIndicator';
      typingDiv.innerHTML = `
        <div class="message-avatar">ğŸ§š</div>
        <div class="message-bubble">
          <div class="typing">
            <span></span>
            <span></span>
            <span></span>
          </div>
        </div>
      `;

      messagesEl.appendChild(typingDiv);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    // éšè—åŠ è½½
    function hideTyping() {
      const typing = document.getElementById('typingIndicator');
      if (typing) typing.remove();
    }

    // HTML è½¬ä¹‰
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // å‘é€æ¶ˆæ¯
    function sendMessage() {
      const input = document.getElementById('messageInput');
      const message = input.value.trim();

      if (!message) return;

      if (!isConnected) {
        addMessage('assistant', 'âš ï¸ æœªè¿æ¥åˆ°æ¡Œé¢ï¼Œè¯·ç¡®ä¿ç”µè„‘ç«¯ Menu Bar App æ­£åœ¨è¿è¡Œ');
        return;
      }

      // æ ¹æ®æ¨¡å¼é€‰æ‹©å‘é€æ–¹å¼
      if (usePolling) {
        // HTTP è½®è¯¢æ¨¡å¼
        sendMessageViaHttp(message);
      } else {
        // WebSocket æ¨¡å¼
        input.value = '';
        addMessage('user', message);
        showTyping();

        ws.send(JSON.stringify({
          type: 'mobile_chat',
          message: message
        }));
      }
    }

    // å¿«æ·æ¶ˆæ¯
    function quickMsg(msg) {
      document.getElementById('messageInput').value = msg;
      sendMessage();
    }

    // å›è½¦å‘é€
    document.getElementById('messageInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage();
    });

    // å¯åŠ¨è¿æ¥
    connect();

    console.log('ğŸ§š é‚“æ©èµåŸç”Ÿ APP v1.0 å·²å¯åŠ¨');
  </script>
</body>
</html>
