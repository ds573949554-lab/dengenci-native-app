<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>é‚“æ©èµ</title>
  <script src="capacitor.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'PingFang HK', sans-serif;
      background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .header {
      background: rgba(0,0,0,0.2);
      padding: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: white;
    }
    .header h1 { font-size: 18px; }
    .status {
      padding: 6px 12px;
      border-radius: 12px;
      font-size: 12px;
      background: rgba(244,67,54,0.3);
      color: #F44336;
    }
    .status.connected {
      background: rgba(76,175,80,0.3);
      color: #4CAF50;
    }
    .chat {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }
    .message {
      margin-bottom: 12px;
      display: flex;
      align-items: flex-start;
      gap: 8px;
    }
    .message.user {
      flex-direction: row-reverse;
    }
    .avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      flex-shrink: 0;
    }
    .bubble {
      max-width: 70%;
      padding: 12px 16px;
      border-radius: 18px;
      font-size: 14px;
      line-height: 1.5;
    }
    .message.assistant .bubble {
      background: white;
      color: #333;
      border-bottom-left-radius: 4px;
    }
    .message.user .bubble {
      background: #667eea;
      color: white;
      border-bottom-right-radius: 4px;
    }
    .input-area {
      background: rgba(0,0,0,0.2);
      padding: 12px 16px;
      display: flex;
      gap: 8px;
    }
    .input-area input {
      flex: 1;
      padding: 12px 16px;
      border: none;
      border-radius: 24px;
      font-size: 14px;
      outline: none;
    }
    .input-area button {
      padding: 12px 20px;
      border: none;
      border-radius: 24px;
      background: #667eea;
      color: white;
      font-size: 14px;
      cursor: pointer;
    }
    .input-area button:disabled {
      background: #999;
    }
    .config {
      padding: 12px;
      background: rgba(0,0,0,0.3);
    }
    .config input {
      width: 100%;
      padding: 10px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      margin-bottom: 8px;
    }
    .config button {
      width: 100%;
      padding: 10px;
      border: none;
      border-radius: 8px;
      background: #4CAF50;
      color: white;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>ğŸ’ é‚“æ©èµ</h1>
    <span class="status" id="status">âšª æœªè¿æ¥</span>
  </div>

  <div class="config" id="configPanel">
    <input type="text" id="serverIp" placeholder="æœåŠ¡å™¨IP" value="192.168.110.252">
    <button onclick="saveAndConnect()">ğŸ”— è¿æ¥</button>
  </div>

  <div class="chat" id="chat"></div>

  <div class="input-area">
    <input type="text" id="msgInput" placeholder="åŒæˆ‘è®²å˜¢..." onkeypress="if(event.key==='Enter')send()">
    <button onclick="send()" id="sendBtn">å‘é€</button>
  </div>

  <script>
    // é…ç½®
    const serverIp = localStorage.getItem('dengenci_ip') || '192.168.110.252';
    document.getElementById('serverIp').value = serverIp;

    const API_URL = `http://${serverIp}:3001`;
    let isConnected = false;
    let pollTimer = null;
    let lastCheck = 0;

    // é¡µé¢åŠ è½½æ—¶è¿æ¥
    window.onload = () => {
      if (serverIp) {
        connect();
      }
    };

    // ä¿å­˜å¹¶è¿æ¥
    function saveAndConnect() {
      const ip = document.getElementById('serverIp').value.trim();
      if (ip) {
        localStorage.setItem('dengenci_ip', ip);
        location.reload();
      }
    }

    // è¿æ¥æœåŠ¡å™¨
    async function connect() {
      updateStatus('â³ è¿æ¥ä¸­...', false);

      try {
        // æµ‹è¯•HTTPè¿æ¥
        const response = await fetch(`${API_URL}/health`, { timeout: 5000 });
        const data = await response.json();

        if (data.status === 'ok') {
          isConnected = true;
          updateStatus('âœ… å·²è¿æ¥', true);
          document.getElementById('configPanel').style.display = 'none';

          // å¼€å§‹è½®è¯¢
          startPolling();

          // æ·»åŠ æ¬¢è¿æ¶ˆæ¯
          addMsg('assistant', 'ä½ å¥½ï¼æˆ‘ç³»é‚“æ©èµï¼Œå·²ç»å‡†å¤‡å¥½åŒä½ å€¾åˆå•¦ï½');
        } else {
          updateStatus('âŒ æœåŠ¡å™¨å¼‚å¸¸', false);
        }
      } catch (err) {
        updateStatus('âŒ è¿æ¥å¤±è´¥', false);
        console.error('è¿æ¥é”™è¯¯:', err);
      }
    }

    // å¼€å§‹è½®è¯¢
    function startPolling() {
      // æ¯2ç§’æ£€æŸ¥ä¸€æ¬¡æ¶ˆæ¯
      pollTimer = setInterval(async () => {
        if (!isConnected) return;

        try {
          const response = await fetch(`${API_URL}/poll?t=${Date.now()}`);
          const data = await response.json();

          if (data.messages && data.messages.length > 0) {
            data.messages.forEach(msg => {
              if (msg.type === 'desktop_chat_response') {
                addMsg('assistant', msg.message);
              }
            });
          }
        } catch (err) {
          console.error('è½®è¯¢é”™è¯¯:', err);
        }
      }, 2000);
    }

    // å‘é€æ¶ˆæ¯
    async function send() {
      const input = document.getElementById('msgInput');
      const msg = input.value.trim();
      if (!msg || !isConnected) return;

      // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
      addMsg('user', msg);
      input.value = '';

      // å‘é€åˆ°æœåŠ¡å™¨
      try {
        const response = await fetch(`${API_URL}/send`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: msg })
        });

        if (!response.ok) {
          addMsg('assistant', 'âš ï¸ å‘é€å¤±è´¥ï¼Œè¯·é‡è¯•');
        }
      } catch (err) {
        addMsg('assistant', 'âš ï¸ ç½‘ç»œé”™è¯¯');
        console.error('å‘é€é”™è¯¯:', err);
      }
    }

    // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©
    function addMsg(role, text) {
      const chat = document.getElementById('chat');
      const div = document.createElement('div');
      div.className = `message ${role}`;
      div.innerHTML = `
        <div class="avatar">${role === 'user' ? 'ğŸ‘¤' : 'ğŸ§š'}</div>
        <div class="bubble">${escapeHtml(text)}</div>
      `;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    // æ›´æ–°çŠ¶æ€
    function updateStatus(text, connected) {
      const status = document.getElementById('status');
      status.textContent = text;
      status.className = 'status' + (connected ? ' connected' : '');
    }

    // HTMLè½¬ä¹‰
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>
